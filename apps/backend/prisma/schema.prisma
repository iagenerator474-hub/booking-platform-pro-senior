// Prisma schema
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Prisma 7.x: la connexion (DATABASE_URL) est gérée via prisma.config.ts
}

model Booking {
  id String @id @default(uuid())

  // --- Métier (aligné code + tests) ---
  firstName String
  lastName  String
  email     String
  date      String
  time      String

  // --- Paiement / Stripe ---
  status               String  @default("en attente") // "en attente" | "payé"
  stripeSessionId       String? @unique
  stripePaymentIntentId String?
  amountTotal           Int?
  currency              String?

  // Relation (lecture/audit)
  paymentEvents PaymentEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email, date, time])
}

model PaymentEvent {
  id              String   @id @default(uuid())
  stripeEventId   String   @unique
  type            String
  stripeSessionId String?
  bookingId       String?
  processedAt     DateTime @default(now())

  // Relation DB propre (FK). Optionnelle car bookingId est nullable.
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([stripeSessionId])
  @@index([bookingId])
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         String   // ADMIN | OPS | READONLY
  isActive     Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([isActive])
}

