// Prisma schema
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Prisma 7.x: la connexion (DATABASE_URL) est gérée via prisma.config.ts
}

model Booking {
  id String @id @default(uuid())

  // --- Métier (aligné code + tests) ---
  firstName String
  lastName  String
  email     String
  date      String
  time      String

  // --- Paiement / Stripe ---
  status                String  @default("en attente") // "en attente" | "payé"
  stripeSessionId       String? @unique
  stripePaymentIntentId String?
  amountTotal           Int?
  currency              String?

  // Relation (lecture/audit)
  paymentEvents PaymentEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email, date, time])
}

model PaymentEvent {
  id            String @id @default(uuid())
  stripeEventId String @unique
  type          String

  // ✅ P0: idempotence persistée par stripeSessionId (1 event traité par session)
  // Postgres: UNIQUE sur champ nullable autorise plusieurs NULL (OK pour autres event types)
  stripeSessionId String? @unique

  // ✅ FK optionnelle vers Booking (no-booking allowed)
  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  processedAt DateTime @default(now())

  @@index([bookingId])
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  role         String // ADMIN | OPS | READONLY
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([isActive])
}
